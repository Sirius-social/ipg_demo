<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{title}}</title>
    <link rel="icon" type="image/png" href="/static/icons/favicon.png"/>
    <link href="{{ static.styles }}" rel="stylesheet">
    <script src="{{ static.vue }}"></script>
    <script src="{{ static.axios }}"></script>
    <script src="{{ static.jquery }}"></script>
    <script src="{{ static.jseditor }}"></script>
    <script src="https://cdn.zoomcharts-cloud.com/1/stable/zoomcharts.js"></script>

    <style>
        div.json{
          background-color: #1a1e21;
          color: white;
          margin: 0;
          padding:0;
        }

        div.json .key {
          color: lightgreen;
        }

        div.json > code {
          color: lightgrey;
        }

        div.json .string {
          color: white;
        }
    </style>
</head>
<body>

    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top shadow-sm" id="mainNav">
        <div class="container px-5">
            <img src="{{ url_for('static', path='/icons/logo.png') }}" style="max-width: 70px; max-height:70px;">
            <a class="navbar-brand fw-bold" href="#">Demo for {{title}}</a>
            <button aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"
                    data-bs-target="#navbarResponsive" data-bs-toggle="collapse" type="button">
                Menu
                <i class="bi-list"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto me-4 my-3 my-lg-0">
                    <!--
                    <li class="nav-item"><a class="nav-link me-lg-3" href="{{features}}" target="_blank">Features</a></li>
                    <li class="nav-item"><a class="nav-link me-lg-3" href="{{download}}" target="_blank">Download</a></li>
                    -->
                    <li class="nav-item btn-danger"><a class="nav-link me-lg-3" href="{{reset_link}}">Reset All data</a></li>
                </ul>
                <!--
                <button class="btn btn-primary rounded-pill px-3 mb-2 mb-lg-0" data-bs-target="#feedbackModal"
                        data-bs-toggle="modal">
                            <span class="d-flex align-items-center">
                                <i class="bi-chat-text-fill me-2"></i>
                                <span class="small">Send Feedback</span>
                            </span>
                </button>
                -->
            </div>
        </div>
    </nav>

    <!-- Mashead header-->
    <header class="masthead" id="app">

        <!-- Modal Window --->
        <div class="modal" id="modal-window" style="background-color: rgba(0,0,0,0.3)" tabindex="-1" role="dialog" aria-labelledby="original" aria-hidden="true">
          <div class="modal-dialog modal-md" role="document" style="margin-top:10%;">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="text-primary modal-title" >[[modal_window.title]]</h5>
              </div>
              <div class="modal-body">
                  <p v-if="modal_window.text">[[modal_window.text]]</p>
                  <div v-if="modal_window.copy.enable" class="row card-body">
                      <a class="col-2"
                         @click.prevent="copy_to_clipboard" href="" title="Copy to Clipboard" style="float: left; cursor: pointer;"
                      >
                          <img src="/static/copy.svg" style="width: 20px; height: 20px; float: left; margin: 0;">
                      </a>
                      <p style="cursor: pointer;overflow: auto;font-size: 70%;" @click.prevent="copy_to_clipboard" v-if="modal_window.copy.link === false" class="col">[[modal_window.copy.text]]</p>
                      <a style="cursor: pointer;overflow: auto;font-size: 70%;" @click.prevent="copy_to_clipboard" v-if="modal_window.copy.link === true" class="col">[[modal_window.copy.text]]</a>
                  </div>
                  <form class="form-horizontal" method="post" action="#">
                    <h5 v-if="modal_window.form.error" class="text-danger">[[modal_window.form.error]]</h5>
                    <div v-for="field in modal_window.form.fields" class="form-group" style="margin-bottom: 5px;">
                        <label class="fw-light" v-bind:for="field.id" class="cols-sm-2 control-label">[[field.label]]</label>
                        <div class="cols-sm-10">
                            <div class="input-group">
                                <input v-bind:readonly="field.readonly === true" v-if="!field.choices"
                                        v-model="field.value" type="text" class="form-control"
                                        v-bind:name="field.id" v-bind:id="field.id"
                                        v-bind:placeholder="field.placeholder"

                                />
                                <select v-if="field.choices" v-model="field.value" @change="modal_field_changed(field.id)">
                                  <option v-for="option in field.choices" v-bind:value="option.value">
                                    [[ option.text ]]
                                  </option>
                                </select>
                            </div>
                        </div>
                    </div>
                  </form>
                  <div class="row" style="margin-bottom: 10px;"></div>
                  <button v-if="modal_window.btn_cancel.enable" @click.prevent="btn_modal_cancel" class="btn btn-primary">[[modal_window.btn_cancel.caption]]</button>
                  <button v-if="modal_window.btn_accept.enable" @click.prevent="btn_modal_accept" class="btn btn-danger" style="float: right;">[[modal_window.btn_accept.caption]]</button>
                  <img v-if="modal_window.running" src="/static/loading.gif" style="float: right;height: 40px; width: 40px;"/>
              </div>
            </div>
          </div>
        </div>
        <!----- View JSON document window ---->
        <div class="modal" id="modal-json" style="background-color: rgba(0,0,0,0.3)" tabindex="-1" role="dialog" aria-labelledby="original" aria-hidden="true">
          <div class="modal-dialog lg" role="document" style="margin-top:10%;">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="text-primary modal-title" >[[modal_json.title]]</h5>
              </div>
              <div class="modal-body">
                  <p v-if="modal_json.text">[[modal_json.text]]</p>
                  <div class="json" style="font-size: 80%;">
                        <pre><code id="json-document"></code></pre>
                  </div>
                  <div class="row" style="margin-bottom: 10px;"></div>
                  <button @click.prevent="close_modal_json" class="btn btn-primary">Close</button>
              </div>
            </div>
          </div>
        </div>
        <!----- Messaging Window --->
        <div class="modal" id="modal-messaging" style="background-color: rgba(0,0,0,0.3)" tabindex="-1" role="dialog" aria-labelledby="original" aria-hidden="true">
          <div class="modal-dialog lg" role="document" style="margin-top:10%;">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="text-primary modal-title" >[[modal_messaging.title]]</h5>
              </div>
              <div class="modal-body">
                  <p v-if="modal_messaging.text">[[modal_messaging.text]]</p>
                  <textarea readonly="readonly" style="width: 100%; min-height: 200px;overflow: auto;" id="textarea-messaging"></textarea>
                  <div class="row" style="margin: 5px;">
                    <input class="col-lg-8" type="text" placeholder="Enter message to send" v-model="modal_messaging.input">
                    <button @click.prevent="send_message" class="col-lg-3 btn btn-danger">[Send]</button>
                  </div>
                  <button @click.prevent="close_messaging" class="btn btn-primary">Close</button>
              </div>
            </div>
          </div>
        </div>
        <!----- Create Schema Modal  --->
        <div class="modal" id="modal-schema" style="background-color: rgba(0,0,0,0.3)" tabindex="-1" role="dialog" aria-labelledby="original" aria-hidden="true">
          <div class="modal-dialog lg" role="document" style="margin-top:10%;">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="text-primary modal-title" >[[modal_schema.title]]</h5>
              </div>
              <div class="modal-body">
                  <p>[[modal_schema.text]]</p>
                  <!-- FORM: Create Schema -->
                  <form v-if="modal_schema.mode === 1" class="form-horizontal" method="post" action="#">
                    <h5 v-if="modal_schema.error" class="text-danger">[[modal_schema.error]]</h5>
                    <div class="form-group" style="margin-bottom: 5px;">
                        <label class="fw-light col-lg-2" class="cols-sm-2 control-label">Issuer</label>
                        <select class="col-lg-8" v-if="modal_schema.choices" v-model="modal_schema.did">
                          <option v-for="option in modal_schema.choices" v-bind:value="option.value">
                            [[ option.text ]]
                          </option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 5px;">
                        <label class="fw-light col-lg-4" class="cols-sm-2 control-label">Schema name</label>
                        <input class="col-lg-6" type="text" placeholder="Press schema name" v-model="modal_schema.name">
                    </div>
                    <div class="form-group" style="margin-bottom: 5px;">
                        <label class="fw-light col-lg-4" class="cols-sm-2 control-label">Schema version</label>
                        <input class="col-lg-6" type="text" placeholder="Press schema ver" v-model="modal_schema.ver">
                    </div>
                    <span class="text-black-50">Attributes:</span>
                    <table style="margin-left: 50px;">
                        <tr v-for="(attr, index) in modal_schema.attrs" :key="attr.id">
                            <td><button @click.prevent="remove_schema_attr(index)" class="btn btn-outline-danger btn-sm" title="Remove">-</button></td>
                            <td><input v-model="attr.name" type="text" class="form-control form-control-sm col-6" placeholder="Enter attribute name"/></td>
                        </tr>
                        <tr>
                            <td><button @click.prevent="append_schema_attr" class="btn btn-outline-primary btn-sm" title="Append">+</button></td>
                            <td></td>
                        </tr>
                    </table>
                  </form>
                  <!-- FORM: Load Schema -->
                  <form v-if="modal_schema.mode === 2" class="form-horizontal" method="post" action="#">
                      <h5 v-if="modal_schema.error" class="text-danger">[[modal_schema.error]]</h5>
                      <div class="form-group" style="margin-bottom: 5px;">
                         <label class="fw-light col-lg-4" class="cols-sm-2 control-label">Enter Schema ID</label>
                         <input class="col-lg-6" type="text" placeholder="xxx:2:yyy:1.0" v-model="modal_schema.name">
                         <button style="margin-bottom: 5px;" @click.prevent="schema_loading" class="btn btn-outline-warning btn-sm">Load...</button>
                      </div>
                      <div class="d-flex justify-content-center" style="padding-bottom: 10px;" >
                        <img v-if="modal_schema.loading" src="/static/loading.extra.gif" style="float: right;height: 100px; width: 100px;"/>
                      </div>
                      <!---  -->
                      <span class="text-black-50">Attributes:</span>
                      <table style="margin-left: 50px;">
                            <tr v-for="(attr, index) in modal_schema.attrs" :key="attr.id">
                                <td><input readonly="readonly" v-model="attr.name" type="text" class="form-control form-control-sm col-6" /></td>
                            </tr>
                      </table>
                  </form>
                  <div class="row" style="margin-bottom: 10px;"></div>
                  <button @click.prevent="modal_schema_close" class="btn btn-primary">Close</button>
                  <button v-if="!modal_schema.running && modal_schema.mode == 1" @click.prevent="schema_registered" class="btn btn-danger" style="float: right;">Register</button>
                  <img v-if="modal_schema.running" src="/static/loading.gif" style="float: right;height: 40px; width: 40px;"/>
                  <button v-if="modal_schema.attrs.length > 0 && modal_schema.mode == 2 && !modal_schema.running" @click.prevent="loaded_schema_store" class="btn btn-danger" style="float: right;">Store loaded schema</button>
              </div>
            </div>
          </div>
        </div>
        <!----- Proof Window modal_proof--->
        <div class="modal" id="modal-proof" style="background-color: rgba(0,0,0,0.3)" tabindex="-1" role="dialog" aria-labelledby="original" aria-hidden="true">
          <div class="modal-dialog lg" role="document" style="margin-top:10%;">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="text-primary modal-title" >Verify Proof</h5>
              </div>
              <h5 v-if="modal_proof.error" class="text-danger">[[modal_proof.error]]</h5>
              <div class="modal-body">
                  <p>[[modal_proof.text]]</p>
                  <h6 class="text-primary">Proof request:</h6>
                  <div id="proof-json-editor" style="width: 100%; min-height: 200px;"></div>
                  <div v-if="modal_proof.result_success != null" class="json" style="font-size: 80%;">
                        <pre><code id="json-document-proof"></code></pre>
                  </div>
                  <p v-if="modal_proof.result_success === true" style="padding: 15px; border-radius: 10px; margin: 10px;" class="alert-success text-lg-center">
                     Verify Success
                  </p>
                  <p v-if="modal_proof.result_success === false" style="padding: 15px; border-radius: 10px; margin: 10px;" class="alert-danger text-lg-center">
                     Verify Error: [[ modal_proof.result_msg.explain ]]
                  </p>
                  <h6 v-if="modal_proof.result_success === true" class="text-primary">Proof (revealed attrs):</h6>
                  <table style="margin-left: 40px;" v-if="modal_proof.result_success === true" class="alert-success p-5">
                      <tr v-for="(item, index) in modal_proof.result_msg">
                          <td><span class="text-black-50">[[index]]: </span></td>
                          <td><span class="text-body">[[item]]</span></td>
                      </tr>
                  </table>
                  <div class="row" style="margin-bottom: 10px;"></div>
                  <button @click.prevent="modal_verify_proof_close" class="btn btn-primary">Close</button>
                  <button v-if="!modal_proof.running" @click.prevent="run_verify_proof" class="btn btn-danger" style="float: right;">Verify</button>
                  <img v-if="modal_proof.running" src="/static/loading.gif" style="float: right;height: 40px; width: 40px;"/>
              </div>
            </div>
          </div>
        </div>
        <!----- Gossyp Modal --->
        <div class="modal" id="modal-gossyp" style="background-color: rgba(0,0,0,0.3)" tabindex="-1" role="dialog" aria-labelledby="original" aria-hidden="true">
          <div class="modal-dialog" role="document" style="margin-top:0%; max-width: 80%;">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="text-primary modal-title" >[[modal_gossyp.title]]</h5>
                <button @click.prevent="detach_from_gossyp" class="btn btn-primary" style="float: right;">Close</button>
              </div>
              <div class="modal-body">
                  <p>[[modal_gossyp.text]]</p>
                  <h6 class="text-danger">[[modal_gossyp.error]]</h6>
                  <table style="width: 100%;">
                      <tr>
                          <td v-if="modal_gossyp.mode ==1" style="width: 40%;">
                              <span class="text-primary">Members:</span>
                              <select v-model="modal_gossyp.new_member" style="width: 50%;">
                                  <option v-for="option in gossyp_avail_members" v-bind:value="option.did">
                                    [[ option.label ]]
                                  </option>
                              </select>
                              <button @click.prevent="add_new_member_to_gossyp(modal_gossyp.new_member)" v-bind:disabled="!modal_gossyp.new_member" class="btn btn-outline-primary btn-sm" title="Add member">+</button>
                              <div class="d-flex row" style="width: 90%;">
                                  <span class="alert-primary" v-for="did in modal_gossyp.members" style="border-radius: 5px; margin: 5px;">
                                      did:dov:[[did]]
                                      <span @click="trace(did)" class="alert-success small" style="cursor:pointer;">route</span>
                                  </span>
                              </div>
                              <textarea id="messaging-gossyp" readonly="readonly" style="min-height: 200px;width: 90%;float: left;"></textarea>
                              <input type="text" v-model="modal_gossyp.message"/>
                              <button @click.prevent="fire_gossyp" class="btn btn-danger" v-bind:disabled="!modal_gossyp.message || modal_gossyp.members.length == 0">Send</button>
                          </td>
                          <td v-if="modal_gossyp.mode == 2" style="width: 40%;">
                              <div class="mx-auto">
                                  <span class="text-primary">Gov Framework:</span>
                                  <select v-model="modal_gossyp.mrg_choice" style="width: 50%;">
                                      <option value="none" disabled="disabled">
                                          Select Gov Framework
                                      </option>
                                      <option v-for="option in modal_gossyp.mrg_choices" v-bind:value="option">
                                        [[ option ]]
                                      </option>
                                  </select>
                                  <button @click.prevent="fire_mrg" class="btn btn-danger">Run</button>
                                  <div id="mrg-json-editor" style="width: 90%; min-height: 400px;max-height: 800px;background: black;overflow: auto;"></div>
                              </div>
                          </td>
                          <td><div id="gossyp-map" class="row"></div></td>
                      </tr>
                  </table>
              </div>
            </div>
          </div>
        </div>


        <div class="container px-5">
            <div class="row gx-5 align-items-lg-start">

                    <div class="col-lg-5">
                        <div class="row justify-content-center">
                            <div class="col-md-12">
                                <div class="card">
                                    <!-----------------------------------------------------
                                        My Identities
                                    ------------------------------------------------------->
                                    <div class="card-header">My Identity</div>
                                    <div class="card-body">
                                        <!-- For loop ------>
                                        <div v-for="identity in identities" class="card" style="margin-bottom: 5px;">
                                          <div class="card-body">
                                            <h5 class="card-title">[[identity.did]]</h5>
                                            <h6 class="card-subtitle mb-2 text-muted">[[identity.label]]</h6>
                                            <a @click.prevent="view_invitation(identity.inv, identity.label)" href="#" class="card-link">Invitation</a>
                                          </div>
                                        </div>

                                        <!--------------------------------------------
                                            Button for adding new identity
                                        --------------------------------------------->

                                        <div style="margin-bottom: 10px;" class="d-flex justify-content-center">
                                            <button @click="add_identity" class="btn btn-primary rounded-pill px-3 mb-2 mb-lg-0" data-bs-toggle="modal" title="Add Identity">
                                                <span class="d-flex align-items-center">
                                                    <span class="small">+ Add new identity</span>
                                                </span>
                                            </button>
                                        </div>

                                        <!--------------------------------------------
                                            Schemas
                                        --------------------------------------------->
                                        <!-- Warning Message --->
                                        <p v-if="schemas_and_cred_defs.length === 0 && identities.length > 0" style="padding: 15px; border-radius: 10px;" class="alert-warning text-lg-center">
                                            Create/Load your first Schema
                                        </p>
                                        <p v-if="identities.length === 0" style="padding: 15px; border-radius: 10px;" class="alert-danger text-lg-center">
                                            Create at least one Identity...
                                        </p>
                                        <p v-if="schemas_and_cred_defs.length > 0" style="padding: 15px; border-radius: 10px;" class="alert-warning text-lg-center">
                                            Your Schemas & Cred-Defs
                                        </p>
                                        <!--------------------------------------------
                                            Button for registering Schemas
                                        --------------------------------------------->

                                        <div class="d-flex justify-content-center" style="padding-bottom: 10px;" >
                                            <button v-bind:disabled="identities.length === 0" @click="register_schema(1)" class="btn btn-secondary btn-sm rounded-pill px-3 mb-2 mb-lg-0 m-auto" data-bs-toggle="modal" title="Add Identity">
                                                <span class="d-flex align-items-center">
                                                    <span class="small">+ Create schema</span>
                                                </span>
                                            </button>
                                            <button v-bind:disabled="identities.length === 0" @click="register_schema(2)" class="btn btn-secondary btn-sm rounded-pill px-3 mb-2 mb-lg-0 m-auto" data-bs-toggle="modal" title="Add Identity">
                                                <span class="d-flex align-items-center">
                                                    <span class="small">+ Load schema from Registry</span>
                                                </span>
                                            </button>
                                            <div class="d-flex justify-content-center" style="padding-bottom: 10px;" ></div>
                                        </div>

                                        <!--------------------------------------------
                                            Schemas & Cred-Defs
                                        --------------------------------------------->
                                        <div v-for="schema in schemas_and_cred_defs" class="card border-warning" style="margin-bottom: 5px;">
                                          <div class="card-body">
                                            <h5 class="card-title">Schema "[[schema.name]]" (version: [[schema.ver]])</h5>
                                            <h6 class="card-subtitle mb-2 text-muted">[[schema.id]]</h6>
                                            <span class="text-primary">Attributes:</span>
                                            <span style="margin-right: 5px;" class="btn btn-primary btn-sm" v-for="attr in schema.attrNames">[[attr]]</span>
                                            <div class="row" style="margin-bottom: 10px;"></div>
                                            <!--- Cred-Defs ---->
                                            <div v-for="cred_def in schema.cred_defs" class="card alert-primary" style="margin-bottom: 5px;">
                                              <div class="card-body" >
                                                <h5 style="font-size: 80%;"  class="card-title">Cred-Def "[[cred_def.id]]"</h5>
                                                <h6 style="font-size: 80%;" class="card-subtitle mb-2 text-muted">[[cred_def.label]]</h6>
                                              </div>
                                            </div>
                                            <!------------------>
                                          </div>
                                          <div class="d-flex justify-content-center" style="padding-bottom: 10px;">
                                              <button @click="add_cred_def(schema.id)" class="btn btn-sm btn-outline-primary rounded-pill px-3" data-bs-toggle="modal" title="Add Credential Definition">
                                                <span class="d-flex align-items-center">
                                                    <span class="small">+ Cred-Def</span>
                                                </span>
                                              </button>
                                          </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>


                    <div class="col-lg-4">
                        <div class="row justify-content-center">
                            <div class="col-md-14">
                                <div class="card">
                                    <!-----------------------------------------------------
                                        My Connections
                                    ------------------------------------------------------->
                                    <div class="card-header">Connections</div>
                                    <div class="card-body">

                                        <!-- Warning Message --->
                                        <p v-if="identities.length === 0" style="padding: 15px; border-radius: 10px;" class="alert-danger text-lg-center">
                                            Create at least one Identity to establish P2P connections with others
                                        </p>

                                        <!-- For loop ------>
                                        <div v-for="conn in connections" class="card" style="margin-bottom: 5px;">
                                          <div class="card-body">
                                            <h5 class="card-title">[[conn.their.label]]</h5>
                                            <h6 class="card-subtitle mb-2 text-muted" style="font-size: 90%;">
                                                <span class="text-danger" style="padding: 3px;">Their</span>did:sov:[[conn.their.did]]
                                            </h6>
                                              <h6 class="card-subtitle mb-2 text-muted" style="font-size: 90%;">
                                                  <span class="text-success" style="padding: 3px;">Mine</span>did:sov:[[conn.me.did]]
                                                  <span class="text-black-50" style="padding: 3px;">[[get_my_label(conn.me.did)]]</span>
                                              </h6>
                                            <a @click.prevent="view_json_document('DIDDoc', conn.their.did_doc, conn.their.label)" href="#" class="card-link">DIDDoc</a>
                                            <a @click.prevent="open_messaging('Messaging', conn.their.label, conn.their.did)" href="#" class="card-link">
                                                Messaging
                                                <span v-if="conn.messaging.counter>0">([[conn.messaging.counter]])</span>
                                            </a>
                                            <a v-if="can_issue" @click.prevent="issue_cred(conn.their.did)" href="#" class="card-link">Issuing</a>
                                            <a v-if="!can_issue" @click.prevent="alert('Register Cred-Defs')" href="#" class="card-link text-black-50">Issuing</a>
                                            <a @click.prevent="verify_proof(conn.their.did)" href="#" class="card-link">Proofing</a>
                                          </div>
                                        </div>

                                        <!--------------------------------------------
                                            Button for adding new connection
                                        --------------------------------------------->

                                        <div v-if="identities.length > 0" class="d-flex justify-content-center" style="padding-bottom: 10px;" >
                                            <button @click="add_connection" class="btn btn-primary rounded-pill px-3 mb-2 mb-lg-0" data-bs-toggle="modal" title="Add Identity">
                                                <span class="d-flex align-items-center">
                                                    <span class="small">+ Add new connection</span>
                                                </span>
                                            </button>
                                        </div>

                                        <!-----------------------------------------------------
                                            My Credentials
                                        ------------------------------------------------------->
                                        <!-- Warning Message --->
                                        <p v-if="credentials.length === 0" style="padding: 15px; border-radius: 10px;" class="alert-warning text-lg-center">
                                            No one issued Credential for You
                                        </p>
                                        <p v-if="credentials.length > 0" style="padding: 15px; border-radius: 10px;" class="alert-primary text-lg-center">
                                            Digital Credentials
                                        </p>
                                        <!--   -->

                                        <div v-for="cred in credentials" class="card border-primary" style="margin-bottom: 5px;">
                                          <div class="card-body">
                                            <h5 class="card-title text-primary">Credential</h5>
                                            <h6 class="card-subtitle mb-4 text-muted alert-dark p-1">
                                                <b>Issuer:</b> [[cred.issuer]]
                                                <br/>
                                                <b>Issuer DID:</b> [[cred.issuer_did]]
                                            </h6>
                                            <span class="text-primary">Preview:</span>
                                            <table style="margin-left: 30px;font-size: 80%;">
                                                <tr v-for="attr in cred.preview" style="margin-bottom: 10px; ">
                                                    <td><span class="text-black-50 text-sm-start">[[attr.name]]: </span></td>
                                                    <td><span class="text-primary text-sm">[[attr.value]]</span></td>
                                                </tr>
                                            </table>
                                            <h6 class="card-subtitle mb-4 text-muted" style="margin-top:5px;">Comment: [[cred.comment]]</h6>
                                          </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <div class="row justify-content-center">
                            <div class="col-md-14">
                                <div class="card">
                                    <div class="card-header">Networks</div>
                                    <div class="card-body">
                                        <!--  Gossyps --->
                                        <div class="d-flex justify-content-center" style="padding-bottom: 10px;">
                                              <button @click="attach_to_gossyp(1)" class="btn btn-sm btn-outline-primary rounded-pill px-3" data-bs-toggle="modal" title="Add Credential Definition">
                                                <span class="d-flex align-items-center">
                                                    <span class="small">Gossyp</span>
                                                </span>
                                              </button>
                                        </div>
                                        <!--  Machine readable Gov --->
                                        <div class="d-flex justify-content-center" style="padding-bottom: 10px;">
                                              <button @click="attach_to_gossyp(2)" class="btn btn-sm btn-outline-primary rounded-pill px-3" data-bs-toggle="modal" title="Add Credential Definition">
                                                <span class="d-flex align-items-center">
                                                    <span class="small">Machine-readable-Gov</span>
                                                </span>
                                              </button>
                                        </div>
                                        <!--  DLT --->
                                        <div class="d-flex justify-content-center" style="padding-bottom: 10px;">
                                              <button @click="" class="btn btn-sm btn-outline-primary rounded-pill px-3" data-bs-toggle="modal" title="Add Credential Definition">
                                                <span class="d-flex align-items-center">
                                                    <span class="small">DLT</span>
                                                </span>
                                              </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

            </div>
        </div>
    </header>
</body>


<script>
    function JSONstringify(json) {
        if (typeof json != 'string') {
         json = JSON.stringify(json, undefined, 2);
        }
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            var cls = 'number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'key';
                } else {
                    cls = 'string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'boolean';
            } else if (/null/.test(match)) {
                cls = 'null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }

    function makeid(length) {
        var result           = '';
        var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        var charactersLength = characters.length;
        for ( var i = 0; i < length; i++ ) {
          result += characters.charAt(Math.floor(Math.random() * charactersLength));
       }
       return result;
    }

    let identities = {{ identities|tojson(indent=2) }};
    let connections = {{ connections|tojson(indent=2) }};
    let schemas = {{ schemas|tojson(indent=2) }};
    let credentials = {{ credentials|tojson(indent=2) }};
    let default_proof_request = {{ default_proof_request|tojson(indent=2) }};
    /*
    let gossyp_demo = {{ gossyp_demo|tojson(indent=2) }};

     */
    let conn_graph = {{ conn_graph|tojson(indent=2) }};
    let mrg_choices = {{mrg_choices|tojson()}};

    var js_editors = {
        proof_editor: null,
        mrg_editor: null,
        gossyp_graph: null,
        mrg_graph: null
    }

    app = new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            identities: identities,
            connections: connections,
            schemas_and_cred_defs: schemas,
            modal_window: {
                title: 'Test Caption',
                text: 'Test Text',
                copy: {
                    enable: false,
                    text: '',
                    link: true
                },
                btn_cancel: {
                    enable: true,
                    caption: 'Cancel',
                    on_click: null
                },
                btn_accept: {
                    enable: true,
                    caption: 'Accept',
                    on_click: null
                },
                running: false,
                form: {
                    error: 'error',
                    action: 'some-action',
                    reload_on_success: true,
                    fields: []
                }
            },
            modal_json: {
                title: 'JSON Document',
                text: 'Document description',
                doc: {}
            },
            modal_messaging: {
                title: 'Messaging Title',
                text: 'Messaging text',
                their_did: null,
                input: null
            },
            modal_schema: {
                title: 'Register SSI Schema',
                text: 'Use schema for registering Cred-Defs later...',
                name: '',
                ver: '1.0',
                did: '',
                choices: [],
                attrs: [],
                error: '',
                running: false,
                loading: false,
                mode: 1  // 1-Create schema' 2-Load from DKMS
            },
            modal_proof: {
                title: 'Proof',
                text: 'Verify proof',
                running: false,
                proof: null,
                their_did: null,
                error: null,
                result_success: null,
                result_msg: null
            },
            modal_gossyp: {
                title: 'Gossyp',
                text: 'Gossyp-Text',
                mode: 1,
                message: '',
                members: [],
                new_member: null,
                error: null,
                mrg_choices: Object.keys(mrg_choices),
                mrg_choice: 'none',
                mrg_req_id: null
            }
        },
        computed: {
            can_issue: function(){
                for (let i=0; i<this.schemas_and_cred_defs.length; i++) {
                    let schema = this.schemas_and_cred_defs[i];
                    if (schema.cred_defs.length > 0) {
                        return true;
                    }
                }
                return false;
            },
            gossyp_avail_members: function(){
                let collection = [];
                let processed_dids = [];
                for(let i=0; i<this.connections.length;i++) {
                    let conn = this.connections[i];
                    if (!processed_dids.includes(conn.their.did)){
                        if(!this.modal_gossyp.members.includes(conn.their.did)) {
                            let item = {did: conn.their.did, label: conn.their.label};
                            collection.push(item);
                        }
                        processed_dids.push(conn.their.did);
                    }
                }
                return collection;
            },
        },
        methods: {
            // ====== System ===========
            open_modal: function(){
                this.modal_window.running = false;
                this.modal_window.form.error = '';
                $('#modal-window').show();
            },
            close_modal: function(){
                $('#modal-window').hide();
            },
            get_my_label: function(did) {
              let a = did.split(':');
              let _did = a[a.length-1]
              for (let i=0; i<this.identities.length; i++) {
                  let me = this.identities[i];
                  let a = me.did.split(':');
                  let cur_did = a[a.length-1];
                  if (cur_did === _did) {
                      return me.label;
                  }
              }
              return null
            },
            view_json_document: function(title, doc, text=null){
                this.modal_json.title = title;
                this.modal_json.text = text;
                this.modal_json.doc = doc;
                let pretty = JSONstringify(doc);
                setTimeout(function(){
                    $('#json-document').html(pretty);
                }, 100);
                $('#modal-json').show();
            },
            close_modal_json: function(){
                $('#modal-json').hide();
            },
            open_messaging: function(title, text, their_did){
                this.modal_messaging.input = null;
                this.modal_messaging.their_did = their_did;
                this.modal_messaging.title = title;
                this.modal_messaging.text = text;
                $('#textarea-messaging').html('');
                let conn = this.get_connection(their_did);
                if (conn && conn.messaging.queue.length > 0) {
                    for(let i=0; i<conn.messaging.queue.length; i++) {
                        let msg = conn.messaging.queue[i];
                        this.add_message('Their', msg);
                    }
                    conn.messaging.queue = [];
                    conn.messaging.counter = 0;
                }
                $('#modal-messaging').show();
            },
            get_connection: function(their_did){
                let conn = null;
                for(let i=0; i<this.connections.length;i++) {
                    let item = this.connections[i];
                    if (item.their.did === their_did) {
                        conn = item;
                        break;
                    }
                }
                return conn;
            },
            is_me: function(some_did){
                for(let i=0; i<this.connections.length;i++) {
                    let item = this.connections[i];
                    if (item.me.did === some_did) {
                        return true;
                    }
                }
                return false;
            },
            process_message: function(their_did, msg){
                if (their_did == this.modal_messaging.their_did) {
                    this.add_message('Their', msg);
                }
                else {
                    let conn = this.get_connection(their_did);
                    if (conn) {
                        conn.messaging.queue.push(msg);
                        conn.messaging.counter += 1;
                    }
                }
            },
            close_messaging: function(){
                this.modal_messaging.their_did = null;
                $('#modal-messaging').hide();
            },
            add_message: function(from, msg){
                let s = from + ': ' + msg + '\n';
                $('#textarea-messaging').append(s);
            },
            btn_modal_cancel: function(){
                if (this.modal_window.btn_cancel.on_click) {
                    this[this.modal_window.btn_cancel.on_click]();
                }
                else {
                    this.close_modal();
                }
            },
            btn_modal_accept: function(){
                if (this.modal_window.btn_accept.on_click) {
                    this[this.modal_window.btn_accept.on_click]();
                }
                else {
                    let self = this;
                self.modal_window.running = true;
                self.modal_window.btn_accept.enable = false;
                let payload = {};
                for (let i=0; i<self.modal_window.form.fields.length; i++) {
                    let field = self.modal_window.form.fields[i];
                    payload[field.id] = field.value;
                }
                axios.post(
                    '', {action: this.modal_window.form.action, payload: payload}
                    ).then(function (response) {
                        console.log('======== SUCCESS ========')
                        console.log(response);
                        self.modal_window.form.error = '';
                        if(self.modal_window.form.reload_on_success) {
                            location.reload();
                        }
                        else {
                            self.close_modal();
                        }
                    }).catch(function (error) {
                        self.modal_window.running = false;
                        self.modal_window.form.error = error.data.detail;
                        self.modal_window.btn_accept.enable = true;
                        console.log('======== ERROR ========')
                        console.log(error.data.detail);
                    });
                }
            },
            copy_to_clipboard: function(){
                if (this.modal_window.copy.enable && this.modal_window.copy.text) {
                    let dummy = document.createElement("textarea");
                    document.body.appendChild(dummy);
                    dummy.value = this.modal_window.copy.text;
                    dummy.select();
                    document.execCommand("copy");
                    document.body.removeChild(dummy);
                }
            },
            // ======== Add Identity =========
            add_identity: function(){
                this.modal_window.title = 'Add Identity (Avatar)';
                this.modal_window.text = 'Introduce yourself with multiple Keys and Labels';
                this.modal_window.copy.enable = false;
                this.modal_window.btn_cancel.enable = true;
                this.modal_window.btn_cancel.caption = 'Cancel';
                this.modal_window.btn_cancel.on_click = null;
                this.modal_window.btn_accept.enable = true;
                this.modal_window.btn_accept.on_click = null;
                this.modal_window.btn_accept.caption = 'Submit';
                this.modal_window.form.reload_on_success = true;
                this.modal_window.form.action = 'add-identity';
                this.modal_window.form.fields = [
                    {
                        id: 'label', label: 'Label',
                        value: '{{title}}' + ' [Avatar-' + (this.identities.length+1).toString() + ']',
                        placeholder: 'Enter your presentation name'
                    },
                ];
                this.open_modal();
            },
            // ======== Add connection =========
            add_connection: function(){
                this.modal_window.title = 'Create new connection';
                this.modal_window.text = 'Paste invitation URL (that you received via email, for example) to establish P2P connection';
                this.modal_window.copy.enable = false;
                this.modal_window.btn_cancel.enable = true;
                this.modal_window.btn_cancel.caption = 'Cancel';
                this.modal_window.btn_cancel.on_click = null;
                this.modal_window.btn_accept.enable = true;
                this.modal_window.btn_accept.on_click = null;
                this.modal_window.btn_accept.caption = 'Establish';
                this.modal_window.form.action = 'add-connection';
                this.modal_window.form.reload_on_success = true;
                let choices = []
                for (let i=0; i<this.identities.length; i++) {
                    let identity = this.identities[i];
                    choices.push({
                        text: identity.label,
                        value: identity.did
                    });
                }
                this.modal_window.form.fields = [
                    {
                        id: 'me', label: 'Myself identity',
                        value: choices[0].value,
                        choices: choices
                    },
                    {
                        id: 'invitation', label: 'Invitation URL',
                        value: '',
                        placeholder: 'Paste invitation URL from your partner'
                    },
                ];
                this.open_modal();
            },
            // ======== Open invitation =========
            view_invitation: function(href, label){
                this.modal_window.title = label + ' invitation';
                this.modal_window.text = 'Send invitation to your partner to establish P2P connection...';
                this.modal_window.copy.enable = true;
                this.modal_window.copy.text = href;
                this.modal_window.copy.link = true;
                this.modal_window.btn_cancel.enable = true;
                this.modal_window.btn_cancel.caption = 'Close';
                this.modal_window.btn_cancel.on_click = null;
                this.modal_window.btn_accept.enable = false;
                this.modal_window.form.reload_on_success = false;
                this.modal_window.form.fields = [];
                this.open_modal();
            },
            // ===== Send message ============
            send_message: function(){
                let msg = this.modal_messaging.input;
                let self = this;
                this.modal_messaging.input = '';
                axios.post(
                    '', {
                        action: 'send-message',
                        payload: {their_did: this.modal_messaging.their_did, msg: msg}
                    }
                ).then(function(){
                    self.add_message('Me', msg)
                });

            },
            // ======== Add Cred-Def =========
            add_cred_def: function(schema_id){
                this.modal_window.title = 'Register Cred-Def';
                this.modal_window.text = 'Schema: ' + schema_id;
                this.modal_window.copy.enable = false;
                this.modal_window.btn_cancel.enable = true;
                this.modal_window.btn_cancel.caption = 'Cancel';
                this.modal_window.btn_cancel.on_click = null;
                this.modal_window.btn_accept.enable = true;
                this.modal_window.btn_accept.on_click = null;
                this.modal_window.btn_accept.caption = 'Register Cred-Def';
                this.modal_window.form.action = 'register-cred-def';
                this.modal_window.form.reload_on_success = true;
                let choices = []
                for (let i=0; i<this.identities.length; i++) {
                    let identity = this.identities[i];
                    choices.push({
                        text: identity.label,
                        value: identity.did
                    });
                }
                this.modal_window.form.fields = [
                    {
                        id: 'schema_id', label: 'Schema',
                        value: schema_id,
                        readonly: true
                    },
                    {
                        id: 'did', label: 'Issuer',
                        value: choices[0].value,
                        choices: choices
                    },
                    {
                        id: 'tag', label: 'TAG',
                        value: '',
                        placeholder: 'Declare TAG, for example: MY_TAG'
                    },
                ];
                this.open_modal();
            },
            issue_cred: function(their_did) {
                let p2p = this.get_connection(their_did);
                this.modal_window.title = 'Issue Cred-Def';
                this.modal_window.text = 'Issue to: ' + p2p.their.label;
                this.modal_window.copy.enable = false;
                this.modal_window.btn_cancel.enable = true;
                this.modal_window.btn_cancel.caption = 'Cancel';
                this.modal_window.btn_cancel.on_click = null;
                this.modal_window.btn_accept.enable = true;
                this.modal_window.btn_accept.on_click = null;
                this.modal_window.btn_accept.caption = 'Issue';
                this.modal_window.form.action = 'issue-cred';
                this.modal_window.form.reload_on_success = true;
                let choices = [];
                for (let i=0; i<this.schemas_and_cred_defs.length; i++) {
                    let schema = this.schemas_and_cred_defs[i];
                    for (let j=0; j<schema.cred_defs.length; j++) {
                        let cred_def = schema.cred_defs[j];
                        choices.push({value: cred_def.id, text: cred_def.id})
                    }
                }
                let initial_choice = choices[0].value;
                this.modal_window.form.fields = [
                    {
                        id: 'to', label: 'DID',
                        value: 'did:sov:' + their_did,
                        readonly: true
                    },
                    {
                        id: 'cred_def_id', label: 'Cred-Def',
                        value: initial_choice,
                        choices: choices
                    },
                    {
                        id: 'comment', label: 'Comment'
                    }
                ];
                this.modal_field_changed('cred_def_id');
                this.open_modal();
            },
            modal_field_changed: function(id) {
                console.log('ID: ' + id);
                if (id == 'cred_def_id') {
                    this.modal_window.form.fields = this.modal_window.form.fields.slice(0,3);
                    let cred_def_id = this.modal_window.form.fields[1].value;
                    console.log('Cred-Def-ID: ' + cred_def_id);
                    //return;
                    let schema = null;
                    let cred_def = null;
                    for (let i=0; i<this.schemas_and_cred_defs.length; i++) {
                        let s = this.schemas_and_cred_defs[i];
                        for (let j=0; j<s.cred_defs.length; j++) {
                            let cd = s.cred_defs[j];
                            if (cd.id == cred_def_id) {
                                schema = s;
                                cred_def = cd;
                            }
                        }
                    }
                    if (schema) {
                        let schema_fields = [
                            {
                                id: '__schema_name', label: 'Name', value: schema.name, readonly: true
                            }
                        ];
                        schema_fields.push({
                            id:'__their_label', label: 'Issuer', value: cred_def.label, readonly: true
                        });
                        for (let i=0; i<schema.attrNames.length; i++) {
                            let attr = schema.attrNames[i];
                            schema_fields.push({
                                id: attr, label: attr, value: ''
                            })
                        }
                        for (let i=0; i<schema_fields.length; i++) {
                            let fld = schema_fields[i];
                            this.modal_window.form.fields.push(fld);
                        }
                    }
                }
            },
            // ======= Schemas ============
            register_schema: function(mode){
                this.modal_schema.error = '';
                this.modal_schema.running = false;
                let mode_changed = this.modal_schema.mode != mode;
                this.modal_schema.mode = mode || 1;
                this.modal_schema.loading = false;
                if (this.modal_schema.mode === 2) {
                    this.modal_schema.title = "Load SSI Schema";
                    this.modal_schema.name = '';
                    this.modal_schema.attrs = [];
                }
                else {
                    this.modal_schema.title = "Register SSI Schema";
                }
                if (mode_changed) {
                    this.modal_schema.attrs = [];
                }
                if (this.modal_schema.choices.length == 0) {
                    let choices = []
                    for (let i = 0; i < this.identities.length; i++) {
                        let identity = this.identities[i];
                        choices.push({
                            text: identity.label,
                            value: identity.did
                        });
                    }
                    this.modal_schema.choices = choices;
                    this.modal_schema.did = choices[0].value;
                }
                $('#modal-schema').show();
            },
            schema_registered: function (){
                let self = this;
                this.modal_schema.running = true;
                axios.post(
                    '', {
                        action: 'register-schema',
                        payload: {
                            did: this.modal_schema.did, name: this.modal_schema.name,
                            ver: this.modal_schema.ver,
                            attrs: this.modal_schema.attrs
                        }
                    }
                ).then(function(){
                    self.modal_schema.name = '';
                    location.reload();
                }).catch(function (error) {
                    self.modal_schema.running = false;
                    self.modal_schema.error = error.data.detail;
                    console.log('======== ERROR ========')
                    console.log(error.data.detail);
                });
            },
            schema_loading: function (){
                let self = this;
                this.modal_schema.loading = true;
                this.modal_schema.attrs = [];
                axios.post(
                    '', {
                        action: 'load-schema',
                        payload: {
                            name: this.modal_schema.name,
                        }
                    }
                ).then(function(response){
                    self.modal_schema.loading = false;
                    self.modal_schema.ver = response.data.ver;
                    let attrs = [];
                    for(let i=0; i<response.data.attrNames.length; i++) {
                        let attr = {id:i, name: response.data.attrNames[i]};
                        attrs.push(attr);
                    }
                    self.modal_schema.attrs = attrs;
                    console.log(response.data);
                }).catch(function (error) {
                    self.modal_schema.loading = false;
                    self.modal_schema.error = error.data.detail;
                    console.log('======== ERROR ========')
                    console.log(error.data.detail);
                });
            },
            loaded_schema_store: function(){
                let self = this;
                this.modal_schema.running = true;
                axios.post(
                    '', {
                        action: 'store-loaded-schema',
                        payload: {
                            name: this.modal_schema.name,
                        }
                    }
                ).then(function(response){
                    self.modal_schema.running = false;
                    location.reload();
                }).catch(function (error) {
                    self.modal_schema.running = false;
                    self.modal_schema.error = error.data.detail;
                    console.log('======== ERROR ========')
                    console.log(error.data.detail);
                });
            },
            modal_schema_close: function(){
                $('#modal-schema').hide();
            },
            append_schema_attr: function(){
                this.modal_schema.attrs.push({name: '', id: 0})
            },
            remove_schema_attr: function(index) {
                let attrs = [];
                for (let i=0; i<this.modal_schema.attrs.length; i++) {
                    let item = this.modal_schema.attrs[i];
                    if (i != index) {
                        attrs.push(item);
                    }
                }
                this.modal_schema.attrs = attrs;
            },
            verify_proof: function(their_did) {
                // JS Editors
                if(!js_editors.proof_editor) {
                    js_editors.proof_editor = new JsonEditor('#proof-json-editor', default_proof_request);
                }
                this.modal_proof.their_did = their_did;
                let conn = this.get_connection(their_did);
                this.modal_proof.text = conn.their.label;
                this.modal_proof.running = false;
                this.modal_proof.result_success = null;
                this.modal_proof.result_msg = null;
                $('#modal-proof').show();
            },
            modal_verify_proof_close: function(){
                $('#modal-proof').hide();
            },
            run_verify_proof: function(their_did){
                this.modal_proof.result_success = null;
                this.modal_proof.result_msg = null;
                let proof_request = null;
                let content = js_editors.proof_editor.$container.text();
                try {
                    proof_request = JSON.parse(content);
                } catch (ex) {
                    alert('Wrong JSON Format: ' + ex);
                    return;
                }

                this.modal_proof.running = true;
                let self = this;

                axios.post(
                    '', {
                        action: 'verify',
                        payload: {
                            their_did: this.modal_proof.their_did,
                            proof_request: proof_request
                        }
                    }
                ).then(function(response){
                    self.modal_proof.running = false;
                    console.log(response.data);
                    let success = response.data.success;
                    let msg = response.data.msg;
                    self.modal_proof.result_success = success;
                    self.modal_proof.result_msg = msg;
                    //json-document-proof
                }).catch(function (error) {
                    self.modal_proof.running = false;
                    self.modal_proof.error = error.data.detail;
                    console.log('======== ERROR ========')
                    console.log(error.data.detail);
                });
            },
            // ====== GOSSYP ========
            attach_to_gossyp: function(mode){
                let mode_changed = mode != this.modal_gossyp.mode;
                this.modal_gossyp.mode = mode || 1;
                if (this.modal_gossyp.mode == 2) {
                    this.modal_gossyp.title = 'Machine-Readable Governance';
                    this.modal_gossyp.text = 'Check compliance and find contragents';
                }
                else {
                    this.modal_gossyp.title = 'Gossyp';
                    this.modal_gossyp.text = 'Group messaging';
                }
                this.modal_gossyp.title = this.modal_gossyp.title + ' ' + "{{title}}";
                let graph_created = false;
                // JS MRG Editors
                if(!js_editors.mrg_editor) {
                    js_editors.mrg_editor = new JsonEditor('#mrg-json-editor', {});
                }
                if (!js_editors.gossyp_graph) {
                    js_editors.gossyp_graph = new NetChart({
                        container: document.getElementById("gossyp-map"),
                        area: {
                            height: 800,
                            style: {fillColor: "rgba(14,33,40,0.9)"},
                        },
                        data: {preloaded: conn_graph},
                        auras: {
                            cellSize: 10,
                            overlap: true,
                            enabled: true,
                            drawLimit: 0.8,
                            intensity: 12,
                            defaultStyle: {
                                showInLegend: true,
                                shadowBlur: 35
                            },
                            defaultColors: [
                                "rgba(47,195,47,0.3)",
                                "rgba(213,66,155,0.3)",
                                // "rgba(28,124,213,0.3)",
                                // "rgba(86,185,247,0.3)",
                                "rgba(10,232,235,0.3)"
                            ],
                            /*
                            style: {
                                "   ": {
                                    fillColor: "rgba(254,248,17,0.6)",
                                    shadowColor: "rgba(254,248,17,0.6)",
                                },
                                " ": {
                                    fillColor: "rgba(53,135,136,0.3)",
                                    shadowColor: "rgba(53,135,136,0.7)",
                                },
                                " ": {
                                    fillColor: "rgba(255,255,255,0.7)",
                                    shadowColor: "rgba(255,255,255,0.5)",
                                }
                            }
                            */
                        },
                        style: {
                            nodeLabel: {aspectRatio: 5},
                            multilinkSpacing: 35,
                            linkStrengthAutoScaling: "logaritmic",
                            nodeStyleFunction: function (node) {
                                node.aura = node.data.auras;
                                if (node.data.human) {
                                    node.image = "/static/robots/ktz/human.png";
                                } else {
                                    node.image = "/static/robots/ktz/engine.png";
                                }
                                node.label = node.data.name;
                                node.labelStyle.padding = 1;
                            },
                            linkStyleFunction: function (link) {
                                link.fromDecoration = "circle";
                                link.toDecoration = "arrow";
                                link.label = link.data.label;
                                link.length = 3;
                                link.labelStyle.rotateWithLink = true;
                                if (link.data.request) {
                                    link.fillColor = "red";
                                    link.labelStyle.textStyle.fillColor = "red";
                                } else {
                                    // link.fillColor = "blue";
                                }

                            },
                            node: {
                                radius: 30,
                                imageCropping: true,
                                shadowBlur: 15,
                                shadowColor: "#262626",
                                fillColor: "rgba(44,233,233,0.8)"
                            },
                            nodeHovered: {
                                shadowColor: "white",
                                shadowBlur: 15,
                            },
                            nodeSelected: {
                                lineColor: null
                            },
                            selection: {
                                fillColor: null,
                                lineColor: null
                            },
                            nodeFocused: {
                                fillColor: "white",
                                lineColor: null,
                                shadowColor: "white",
                                shadowBlur: 10
                            }
                        },
                        legend: {
                            enabled: true,
                            padding: 6,
                            marker: {size: 22},
                            maxLineSymbols: 12
                        },
                        navigation: {
                            mode: "showall", // "manual", "showall" or "focusnodes",
                            focusNodeExpansionRadius: 2,
                            focusNodeTailExpansionRadius: 0.3,
                            numberOfFocusNodes: 1,
                            expandOnClick: true
                        },
                        theme: NetChart.themes.dark
                    });
                    graph_created = true;
                }
                if (mode_changed) {
                    this.modal_gossyp.members = [];
                    this.modal_gossyp.message = '';
                    this.modal_gossyp.error = '';
                    this.modal_gossyp.mrg_choice = 'none';
                    if (!graph_created) {
                        js_editors.gossyp_graph.reloadData();
                    }
                }
                $('#modal-gossyp').show();
            },
            detach_from_gossyp: function (){
                $('#modal-gossyp').hide();
            },
            add_new_member_to_gossyp: function(their_did){
                this.modal_gossyp.members.push(their_did);
                this.modal_gossyp.new_member = null;
                let conn = this.get_connection(their_did);
                if (!this.modal_gossyp.members.includes(conn.me.did)) {
                    this.modal_gossyp.members.push(conn.me.did);
                }
                let link_id = conn.me.did + '>' + their_did;
                let data = {
                    nodes: [
                        { id: their_did, loaded: true, name: conn.their.label, auras: ["{{ auras_my_connections }}"] },
                    ], links: [
                        { id: link_id, from: 'me', to: their_did, label: "P2P" }
                    ]
                };
                js_editors.gossyp_graph.addData(data);
            },
            fire_gossyp: function(){
                let self = this;
                this.modal_gossyp.error = "";
                axios.post(
                    '', {
                        action: 'gossyp',
                        payload: {
                            members: this.modal_gossyp.members,
                            message: this.modal_gossyp.message
                        }
                    }
                ).then(function(response){
                    console.log(response.data);
                    let msg = self.modal_gossyp.message;
                    self.modal_gossyp.message = "";
                    //json-document-proof
                    let s = 'Me' + ': ' + msg + '\n';
                    $('#messaging-gossyp').append(s);
                }).catch(function (error) {
                    self.modal_gossyp.error = error.data.detail;
                    console.log('======== ERROR ========')
                    console.log(error.data.detail);
                });
            },
            process_gossyp: function(members, msg, from, graph){
                for (let i=0; i<members.length; i++) {
                    let their_did = members[i];
                    if (!this.modal_gossyp.members.includes(their_did)) {
                        this.modal_gossyp.members.push(their_did);
                    }
                }
                //
                let s = from + ': ' + msg + '\n';
                $('#messaging-gossyp').append(s);
                if (graph) {
                    js_editors.gossyp_graph.addData(graph);
                }
            },
            trace: function(their_did) {
                axios.post(
                    '', {
                        action: 'route',
                        payload: {
                            their_did: their_did,
                        }
                    }
                ).then(function(response){
                    console.log(response.data);
                    let graph = response.data.graph;
                    let pending = response.data.pending;
                    if (!pending && graph) {
                        js_editors.gossyp_graph.addData(graph);
                    }
                }).catch(function (error) {
                    console.log('======== ERROR ========')
                    console.log(error.data.detail);
                });
            },
            close_mrg_modal: function(){
                $('#modal-mrg').hide();
            },
            fire_mrg: function(){
                let self = this;
                this.modal_gossyp.error = "";
                let content = js_editors.mrg_editor.$container.text();
                let doc = null;
                this.modal_gossyp.mrg_req_id = makeid(8);
                try {
                    doc = JSON.parse(content);
                } catch (ex) {
                    alert('Wrong JSON Format: ' + ex);
                    return;
                }
                js_editors.gossyp_graph.reloadData();
                axios.post(
                    '', {
                        action: 'mrg',
                        payload: {
                            doc: doc,
                            req_id: this.modal_gossyp.mrg_req_id
                        }
                    }
                ).then(function(response){
                    console.log(response.data);

                }).catch(function (error) {
                    self.modal_gossyp.error = error.data.detail;
                    console.log('======== ERROR ========')
                    console.log(error.data.detail);
                });
            },
        },
        watch: {
            'modal_gossyp.mrg_choice': function(new_val, old_val){
                console.log('MRG doc changed');
                console.log('Was: ' + old_val);
                console.log('Set: ' + new_val);
                let doc = null;
                for (let i=0; i<this.modal_gossyp.mrg_choices.length; i++ ) {
                    let name = this.modal_gossyp.mrg_choices[i];
                    if (name == new_val) {
                        doc = mrg_choices[name];
                        break;
                    }
                }
                if (doc) {
                    setTimeout(function(){
                        js_editors.mrg_editor = new JsonEditor('#mrg-json-editor', doc);
                    }, 100);
                }
            }
        },
        beforeMount(){
            let self = this;
            function connect() {
                let events_socket = new WebSocket('{{ws}}');
                events_socket.onclose = function (event) {
                    setTimeout(function() {
                      connect();
                    }, 3000);
                };
                events_socket.onopen = function(){
                    console.log('WS EVENTS is Open')
                };
                events_socket.onmessage = function (event) {
                    let s = event.data;
                    let body = JSON.parse(s);
                    console.log(body);
                    let topic = body.topic;
                    let payload = body.payload;
                    if (topic === 'messaging.rcv') {
                        self.process_message(payload.their_did, payload.msg);
                    }
                    else if (topic === 'messaging.gossyp') {
                        self.process_gossyp(payload.members, payload.msg, payload.from, payload.graph);
                    }
                    else if (topic === 'gossyp.graph') {
                        let grapg = payload.graph;
                        js_editors.gossyp_graph.addData(grapg);
                    }
                    else if (topic === 'mrg.graph') {
                        let req_id = payload.req_id;
                        let graph = payload.graph;
                        if (req_id == self.modal_gossyp.mrg_req_id) {
                            if (js_editors.gossyp_graph) {
                                js_editors.gossyp_graph.addData(graph);
                            }
                        }
                    }
                };
                events_socket.onerror = function (error) {
                    console.log("WS Error " + error.message);
                };
            }
            connect();

        }
    });
</script>
</html>